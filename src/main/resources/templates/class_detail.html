<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${classroom.name} + ' - 班级管理'">班级管理</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <style>
        /* 颜色区分 */
        .gender-男 { background-color: #5bc0de; color: white; } /* 蓝色 */
        .gender-女 { background-color: #ff99cc; color: white; } /* 粉色 */
        .gender-空 { background-color: #f8f9fa; color: #6c757d; border: 1px dashed #ccc; } /* 灰色/虚线 */

        /* CSS Grid 布局和间距控制 */
        .seating-grid {
            display: grid;
            grid-template-columns: repeat(var(--cols), 1fr);
            grid-row-gap: var(--row-gap, 15px);
            grid-column-gap: var(--col-gap, 15px);
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 10px;
        }
        .seat-cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px;
            border-radius: 8px;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            font-weight: bold;
            padding: 5px;
            font-size: 0.9em;
        }
        .sortable-chosen {
            border: 2px solid orange !important;
            transform: scale(1.05);
            opacity: 0.9;
        }
        .lecture-desk {
            background-color: #343a40;
            color: white;
            padding: 15px;
            text-align: center;
            grid-column: 1 / -1;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" th:href="@{/home}">« 返回主页</a>
    <span class="navbar-text text-light ml-3">
        当前班级: <strong th:text="${classroom.name}"></strong>
    </span>
    <div class="collapse navbar-collapse justify-content-end">
        <a class="btn btn-outline-light" th:href="@{/logout}">退出登录</a>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div th:if="${successMessage}" class="alert alert-success"><span th:text="${successMessage}"></span></div>
    <div th:if="${errorMessage}" class="alert alert-danger"><span th:text="${errorMessage}"></span></div>

    <h1 class="mb-4" th:text="${classroom.name} + ' - 座位管理面板'">座位管理面板</h1>
    <hr>

    <div class="row">
        <div class="col-md-3">
            <div class="list-group mb-4">
                <a href="#" class="list-group-item list-group-item-action active">座位排布</a>
                <a th:href="@{/class/{id}/students(id=${classroom.id})}" class="list-group-item list-group-item-action">学生信息管理</a>
                <a th:href="@{/class/{id}/groups(id=${classroom.id})}" class="list-group-item list-group-item-action">分组策略管理</a>
                <a th:href="@{/seating/records/{id}(id=${classroom.id})}" class="list-group-item list-group-item-action">排座历史记录</a>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    当前座位布局
                    <button class="btn btn-sm btn-light float-right ml-2" id="btnSaveArrangement">保存排座</button>
                    <button class="btn btn-sm btn-warning float-right" id="btnRandomArrange">随机排座</button>
                    <button class="btn btn-sm btn-info float-right mr-3" data-toggle="modal" data-target="#layoutModal">设置布局</button>
                </div>
                <div class="card-body" id="seatingArea" style="min-height: 500px; background-color: #eee; padding: 0;">
                    <div class="lecture-desk">讲台 / Blackboard</div>
                    <div id="seatingGridContainer">
                        <h4 class="text-center text-muted mt-5">请先设置布局或点击随机排座</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="layoutModal" tabindex="-1" role="dialog" aria-labelledby="layoutModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="layoutModalLabel">设置座位布局</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <form th:action="@{/seating/layout/update}" method="post">
                <div class="modal-body">
                    <input type="hidden" name="classId" th:value="${classroom.id}">

                    <div class="form-group">
                        <label for="rows">行数 (Rows)</label>
                        <input type="number" class="form-control" id="rows" name="rows" min="1" required
                               th:value="${layoutRows}">
                    </div>

                    <div class="form-group">
                        <label for="cols">列数 (Cols)</label>
                        <input type="number" class="form-control" id="cols" name="cols" min="1" required
                               th:value="${layoutCols}">
                    </div>

                    <div class="form-group">
                        <label for="rowSpacing">行间距 (像素)</label>
                        <input type="number" class="form-control" id="rowSpacing" name="rowSpacing" th:value="${classroom.rowSpacing != null ? classroom.rowSpacing : 15}" min="5" required>
                    </div>
                    <div class="form-group">
                        <label for="colSpacing">列间距 (像素)</label>
                        <input type="number" class="form-control" id="colSpacing" name="colSpacing" th:value="${classroom.colSpacing != null ? classroom.colSpacing : 15}" min="5" required>
                    </div>
                    <p class="text-danger">当前班级有 <strong id="studentCountDisplay">[[${studentCount ?: 0}]]</strong> 位学生。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存布局</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // 假设 Controller 已经正确传入 layoutRows 和 layoutCols
    const classId = [[${classroom.id}]];
    const seatingGridContainer = $('#seatingGridContainer');

    // --- 渲染逻辑 ---
    function renderSeatingGrid(result) {
        seatingGridContainer.empty();

        const rows = result.rows;
        const cols = result.cols;

        // 从输入框中获取最新的间距值，确保实时渲染效果
        const rowSpacing = $('#rowSpacing').val() || 20;
        const colSpacing = $('#colSpacing').val() || 20;

        // 动态设置 CSS 变量
        let gridHtml = '<div class="seating-grid"' +
            'style="--cols: ' + cols + ';' +
            '--row-gap: ' + rowSpacing + 'px;' +
            '--col-gap: ' + colSpacing + 'px;">';

        for (let r = 1; r <= rows; r++) {
            for (let c = 1; c <= cols; c++) {
                // 查找当前座位分配的学生
                const position = result.layout.find(p => p.row === r && p.col === c);

                const studentName = position && position.studentName ? position.studentName : '空座';
                const gender = position && position.gender ? position.gender : '空';
                const studentId = position && position.studentId ? position.studentId : 0;

                // 单元格结构 (拖拽对象)
                gridHtml += `<div class="seat-cell gender-${gender}"
                          data-row="${r}" data-col="${c}" data-id="${studentId}"
                          data-gender="${gender}" data-name="${studentName}">
                            ${studentName}
                            <small>(${r}-${c})</small>
                          </div>`;
            }
        }
        gridHtml += '</div>';
        seatingGridContainer.html(gridHtml);

        // 激活拖拽功能 (SortableJS)
        new Sortable(document.querySelector('.seating-grid'), {
            animation: 150,
            draggable: '.seat-cell',
            onEnd: function (evt) {
                alert('座位已交换！请点击 "保存排座" 按钮进行保存。');
                // TODO: 真正的保存逻辑需要在点击保存按钮时实现
            }
        });

        // 实现不规则座位：双击删除座位框
        document.querySelectorAll('.seat-cell').forEach(cell => {
            cell.addEventListener('dblclick', function() {
                // 修正：增加不能删除空座的逻辑
                if (this.dataset.id === '0' || this.dataset.id === '') {
                    alert('不能删除空座或未分配座位的单元格。');
                    return;
                }
                if (confirm('确定要删除这个座位 (' + this.dataset.row + '-' + this.dataset.col + ') 吗？')) {
                    this.remove();
                    alert('座位已删除，请记得保存布局。');
                    // TODO: 在这里更新全局布局变量，用于保存时的提交
                }
            });
        });
    }

    // --- 随机排座按钮点击事件 ---
    $('#btnRandomArrange').click(function() {
        // 禁用按钮并显示加载中
        $(this).prop('disabled', true).text('正在排座...');

        $.ajax({
            url: '/seating/arrange/' + classId,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response && response.layout) {
                    renderSeatingGrid(response);
                    alert('随机排座完成！');
                } else {
                    alert('排座失败：后端返回数据格式错误。');
                }
            },
            error: function(xhr) {
                let errorMsg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : '排座失败，请检查布局设置。';
                seatingGridContainer.html('<div class="alert alert-danger mt-5">' + errorMsg + '</div>');
                alert(errorMsg);
            },
            complete: function() {
                $('#btnRandomArrange').prop('disabled', false).text('随机排座');
            }
        });
    });

    // --- 保存排座逻辑 (待实现) ---
    $('#btnSaveArrangement').click(function() {
        alert('请实现保存排座逻辑！');
        // TODO: 实现收集布局数据，并 POST 到 /seating/save/{classId}
    });

    /*]]>*/
</script>

</body>
</html>